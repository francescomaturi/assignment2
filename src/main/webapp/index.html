<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<title>Assignment 2 RESTServer</title>
<link href="css/bootstrap.css" rel="stylesheet">
<link href="css/bootstrap-responsive.css" rel="stylesheet">
<link href="css/datepicker.css" rel="stylesheet">
<link href="css/bootstrap-overrides.css" rel="stylesheet">
<script type="text/javascript" src="js/jquery-1.10.2.js"></script>
<script type="text/javascript" src="js/bootstrap.js"></script>
<script type="text/javascript" src="js/bootstrap-datepicker.js"></script>
<script type="text/javascript" src="js/json2.js"></script>
<script type="text/javascript" src="js/underscore.js"></script>
<script type="text/javascript" src="js/backbone/backbone.js"></script>
<script type="text/javascript" src="js/backbone/backbone-relational.js"></script>
<script type="text/javascript" src="js/backbone/backbone.EditPerson.js"></script>
<script type="text/javascript" src="js/backbone/backbone.PersonList.js"></script>
<!-- <script type="text/javascript" src="js/backbone/backbone.ShowPerson.js"></script> -->
<script type="text/javascript" src="js/backbone/backbone.DeletePerson.js"></script>

<script type="text/javascript">
	$(document).ready(
			function() {
				var clientDirectory = "/../";

				$("div#searchModal-container").load(
						clientDirectory + "ajax/searchModal.html");
				
				$("div#navbar-container").load(
						clientDirectory + "ajax/navbar.html");
				
				
				$.get(clientDirectory + "template/person-list-template.html",
						function(data) {
							$(".container").append(data);
						});

				$.get(clientDirectory + "template/new-person-template.html",
						function(data) {
							$(".container").append(data);
						});

				$.get(clientDirectory + "template/show-person-template.html",
						function(data) {
							$(".container").append(data);
						});
				$.get(clientDirectory + "template/edit-healthprofile-template.html",
            function(data) {
              $(".container").append(data);
            });
			});
</script>

</head>
<body>
	<div class="container">
		<div id="searchModal-container"></div>
		<div id="navbar-container"></div>
		<br />
		<div class="page"></div>
	</div>

	<script type="text/javascript">
		$.fn.serializeObject = function() {
			var o = {};
			var a = this.serializeArray();
			$.each(a, function() {
				if (o[this.name] !== undefined) {
					if (!o[this.name].push) {
						o[this.name] = [ o[this.name] ];
					}
					o[this.name].push(this.value || '');
				} else {
					o[this.name] = this.value || '';
				}
			});
			return o;
		};
		
		HealthProfile = Backbone.Model.extend({
      idAttribute: "healthprofile_id",
      urlRoot : function() { return '/person/' + this.get('person_id') + '/healthprofile' }
    });
    
    HealthProfileHistory = Backbone.Collection.extend({
      model: HealthProfile,
      parse : function(response) {
    	    if(response)
    	      return response.healthProfile;
    	    else
    	    	return null;
        }
    });
    
    Person = Backbone.Model.extend({
        urlRoot : '/person',
        initialize : function(options) {
          this.healthProfileHistory = new HealthProfileHistory;
          this.healthProfileHistory.url = function() { return '/person/' + options.id + '/healthprofile'};
          this.healthProfileHistory.bind("reset", this.updateCounts);
        }
      });
    
    var EditHealthProfile = Backbone.View.extend({
        el : '.page',
        render : function(options) {
        	var that = this;
        	if (options.healthprofile_id) {
        		that.hp = new HealthProfile({person_id : options.person_id, healthprofile_id : options.healthprofile_id});
            that.hp.fetch({
     	        success : function(healthProfile) {
     	          var template = _.template($('#edit-healthprofile-template').html(),{healthProfile : healthProfile, person_id : options.person_id});
     	          that.$el.html(template);
     	        }
     	      });
     	    } else {
     	      var template = _.template($('#edit-healthprofile-template').html(), { healthProfile : null, person_id : options.person_id });
     	      that.$el.html(template);
     	    }
        },
       	events : {
       	    'submit .edit-healthprofile-form' : 'saveHealthProfile',
       	    'click .deleteHealthProfile' : 'deleteHealthProfile'
       	},
       	
       	saveHealthProfile : function(ev) {
     	    healthProfileDetails = $(ev.currentTarget).serializeObject();
     	    var person_id = healthProfileDetails.person_id;
     	    var hp = new HealthProfile();
     	    hp.save(healthProfileDetails, {
     	      success : function(healthProfile) {
     	        router.navigate('showPerson/'+ person_id, {trigger : true});
     	      }
     	    })
     	    return false;
     	  },

     	  deleteHealthProfile : function(ev) {
     		  var person_id = this.hp.get('person_id');
     	    this.hp.destroy({
     	      success : function() {
     	        router.navigate('#/showPerson/' + person_id, { trigger : true });
     	      }
     	    });
     	    return false;
     	  }        
      }); 
    
    var DeleteHealthProfile = Backbone.View.extend({
    	  el : '.page',
    	  render : function(options) {
    	    var hp = new HealthProfile({ person_id : options.person_id, healthprofile_id : options.healthprofile_id});
    	    hp.destroy({
    	      success : function() {
    	        router.navigate('#/showPerson/' + options.person_id, {
    	          trigger : true
    	        });
    	      }
    	    });
    	    return false;
    	  }
    	});
    
    var deleteHealthProfile = new DeleteHealthProfile();
      
    
    var ShowPerson = Backbone.View.extend({
        el : '.page',
        render : function(options) {
          var that = this;
          var person = new Person({ id : options.person_id });
            person.fetch({
              success : function(person) {
                person.healthProfileHistory.fetch({
                  success : function(healthProfileHistory){
                    var template = _.template($('#show-person-template').html(), 
                        {person : person, healthProfileHistory : healthProfileHistory.models} );
                    that.$el.html(template);
                  }
                })
              }
            });
        }
    });
		
		
		var personList = new PersonList();
		var editPerson = new EditPerson();
		
		var deletePerson = new DeletePerson();
		var editHealthProfile = new EditHealthProfile();

		$.ajaxPrefilter(function(options, originalOptions, jqXR) {
			options.url = "http://localhost:8080/RESTService/rest"
					+ options.url;
		});

		
		
		
		
		var showPerson = new ShowPerson();

		People = Backbone.Collection.extend({
			model : Person,
			url : '/person',
			parse : function(response) {
				return response.person;
			}
		});
		
		var Router = Backbone.Router.extend({
			routes : {
				'' : "home",
				'newPerson' : "editPerson",
				'editPerson/:person_id' : "editPerson",
				'deletePerson/:person_id' : "deletePerson",
				'showPerson/:person_id' : "showPerson",
				'editPerson/:person_id/editHealthProfile/:healthprofile_id' : "editHealthProfile",
				'editPerson/:person_id/editHealthProfile' : "editHealthProfile",
				'editPerson/:person_id/deleteHealthProfile/:healthprofile_id' : "deleteHealthProfile"
			}
		});

		var router = new Router();
		router.on('route:home', function() {
			personList.render();
		});
		router.on('route:editPerson', function(person_id) {
			editPerson.render({
				person_id : person_id
			});
		});
		router.on('route:deletePerson', function(person_id) {
			deletePerson.render({
				person_id : person_id
			});
		});
		router.on('route:showPerson', function(person_id) {
			showPerson.render({
				person_id : person_id
			});
		});
		router.on('route:editHealthProfile', function(person_id, healthprofile_id) {
			editHealthProfile.render({
        person_id : person_id,
        healthprofile_id : healthprofile_id
      });
    });
		router.on('route:deleteHealthProfile', function(person_id, healthprofile_id) {
      deleteHealthProfile.render({
        person_id : person_id,
        healthprofile_id : healthprofile_id
      });
    });

		Backbone.history.start();
	</script>
</body>
</html>