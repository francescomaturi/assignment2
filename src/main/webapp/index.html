<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<title>Assignment 2 RESTServer</title>
<link href="css/bootstrap.css" rel="stylesheet">
<link href="css/bootstrap-responsive.css" rel="stylesheet">
<link href="css/datepicker.css" rel="stylesheet">
<link href="css/bootstrap-overrides.css" rel="stylesheet">
<script type="text/javascript" src="js/jquery-1.10.2.js"></script>
<script type="text/javascript" src="js/bootstrap.js"></script>
<script type="text/javascript" src="js/json2.js"></script>
<script type="text/javascript" src="js/underscore.js"></script>
<script type="text/javascript" src="js/backbone.js"></script>
<script type="text/javascript" src="js/backbone-relational.js"></script>
<script type="text/javascript" src="js/bootstrap-datepicker.js"></script>

<script type="text/javascript"> 
	$(document).ready(function(){
		$("div#searchModal-container").load("/../ajax/modal.html"); 
		$("div#navbar-container").load("/../ajax/navbar.html"); 
		$.get( "/../template/person-list-template.html", function( data ) {
  		$( ".container" ).append(data);
		});
		$.get( "/../template/new-person-template.html", function( data ) {
  		$( ".container" ).append(data);
		});
		$.get( "/../template/show-person-template.html", function( data ) {
  		$( ".container" ).append(data);
		});
	});
</script> 

</head>
<body>
	<div class="container">
		<div id="searchModal-container"></div>
		<div id="navbar-container"></div>
		<br/>
		<div class="page"></div>
	</div>

	<script type="text/javascript">

		$.fn.serializeObject = function(){
      var o = {};
      var a = this.serializeArray();
      $.each(a, function() {
          if (o[this.name] !== undefined) {
              if (!o[this.name].push) {
                  o[this.name] = [o[this.name]];
              }
              o[this.name].push(this.value || '');
          } else {
              o[this.name] = this.value || '';
          }
      });
      return o;
    };

		$.ajaxPrefilter(function(options, originalOptions, jqXR) {
			options.url = "http://localhost:8080/RESTService/rest" + options.url;
		});

		Person = Backbone.Model.extend({
			urlRoot: '/person',
			initialize: function() {
		    this.healthProfile = new HealthProfile;
		    this.healthProfile.url = '/person/' + this.id + '/healthprofile';
		  }
		});

		HealthProfile = Backbone.Model.extend({});

		People = Backbone.Collection.extend({
			model: Person,
			url : '/person',
			parse: function(response){
		    return response.person;
		  }    
		});

		var PersonList = Backbone.View.extend({
			el : '.page',
			render : function() {
				that = this;
				var persons = new People();
				persons.fetch({
					success : function(people) {
						var template = _.template($('#person-list-template').html(), {
							people : people.models
						});
						that.$el.html(template);
					}
				});
			}
		});

		var personList = new PersonList();

		var EditPerson = Backbone.View.extend({
			el : '.page',
			render : function(options){
				var that = this;
				if(options.person_id){
					var person = new Person({id : options.person_id});
					person.fetch({
						success: function(person){
							var template = _.template($('#new-person-template').html(), {person : person});
							that.$el.html(template);
						}
					});
				} else{
					var template = _.template($('#new-person-template').html(), {person : null});
					this.$el.html(template);
				}
			},
			events : {
				'submit .new-person-form' : 'savePerson',
				'click .deletePerson' : 'deletePerson'
			},
			savePerson : function(ev){
				personDetails = $(ev.currentTarget).serializeObject();
				var person = new Person();
				personDetails.person_id = personDetails.id;
				console.log(personDetails);
				person.save(personDetails, {
					success : function(user){
						router.navigate('', {trigger:true});
					}
				}) 
				return false;
			},

			deletePerson : function(ev){
				this.person.destroy({
					success : function(){
						router.navigate('', {trigger:true});
					}
				});
				return false;
			}
		});

		var editPerson = new EditPerson();

		var ShowPerson = Backbone.View.extend({
			el : '.page',
			render : function(options){
				var that = this;
				var person = new Person({id : options.person_id});
				person.healthProfile.fetch({
					success: function(person){
						var template = _.template($('#show-person-template').html(), {person : person});
						that.$el.html(template);
					}	
				});
			}
		});

		var showPerson = new ShowPerson();


		var DeletePerson = Backbone.View.extend({
			el : '.page',
			render : function(options){
				var person = new Person({id : options.person_id});
				person.destroy({
					success : function(){
						router.navigate('', {trigger:true});
					}
				});
				return false;
			}
		});

		var deletePerson = new DeletePerson();

		
		var Router = Backbone.Router.extend({
			routes : {
				'' : "home",
				'newPerson' : "editPerson",
				'editPerson/:person_id' : "editPerson",
				'deletePerson/:person_id' : "deletePerson",
				'showPerson/:person_id' : "showPerson"
			}
		});

		var router = new Router();
		router.on('route:home', function() {
			personList.render();
		});
		router.on('route:editPerson', function(person_id) {
			editPerson.render({person_id : person_id});
		});
		router.on('route:deletePerson', function(person_id) {
			deletePerson.render({person_id : person_id});
		});
		router.on('route:showPerson', function(person_id) {
			showPerson.render({person_id : person_id});
		});

		Backbone.history.start();
	</script>
</body>
</html>